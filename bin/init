#!/bin/sh

set -e

# check & gen ssl certificate
if [ ! -e "${SSL_CERTFILE}" ] || [ ! -e "${SSL_KEYFILE}" ]; then
  openssl req -newkey rsa:2048 -sha256 -nodes -x509 -days 365 -subj "/O=ElectrumX" -keyout "${SSL_KEYFILE}" -out "${SSL_CERTFILE}"
fi

# check and init tx db
if [ ! -e "${MARIADB}" ]; then
    mariadb-install-db --datadir=${MARIADB}
    /usr/bin/mariadbd-safe --datadir=${MARIADB} &
    echo "Mariadb is created.  Please attach to container as root, and modify/run /data/mysql-db-init.sql"
    echo
    echo "   docker container exec -it -u root \<container id\> ash"
    echo "   \<container\> : mariadb -u root < /data/mysql-db-init.sql"
    echo
else
    /usr/bin/mariadbd-safe --datadir=${MARIADB} &
fi

# get public ip to publicize our service
IP=`wget -qO- ifconfig.me`
export REPORT_SERVICES=ssl://$IP:50002
echo REPORT_SERVICES : $REPORT_SERVICES

# run electrumx server
exec /electrumx/electrumx_server
